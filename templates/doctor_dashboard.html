<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - AlzheimerCare AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .patient-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 5px solid #007bff;
            transition: transform 0.3s ease;
        }
        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .risk-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .risk-low { background: #d4edda; color: #155724; }
        .risk-moderate { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        .appointment-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 5px solid #ffc107;
        }
        .btn-approve {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
        }
        .btn-reject {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-user-md me-2"></i>Doctor Dashboard</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="{{ url_for('doctor_dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-container">
            <div class="welcome-section">
                <h2><i class="fas fa-user-md me-2"></i>Welcome back, Dr. {{ username }}!</h2>
                <p class="mb-0">Patient management and appointment overview</p>
            </div>

            <!-- Stats Overview -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon" style="background: linear-gradient(45deg, #007bff, #6610f2); width: 60px; height: 60px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 1rem;">
                            <i class="fas fa-users"></i>
                        </div>
                        <h4>Total Patients</h4>
                        <h3 id="totalPatients">Loading...</h3>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon" style="background: linear-gradient(45deg, #28a745, #20c997); width: 60px; height: 60px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 1rem;">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h4>Pending Appointments</h4>
                        <h3 id="pendingAppointments">Loading...</h3>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon" style="background: linear-gradient(45deg, #ffc107, #fd7e14); width: 60px; height: 60px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h4>High Risk Patients</h4>
                        <h3 id="highRiskPatients">Loading...</h3>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon" style="background: linear-gradient(45deg, #17a2b8, #6610f2); width: 60px; height: 60px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 1rem;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h4>Assessments Today</h4>
                        <h3 id="assessmentsToday">Loading...</h3>
                    </div>
                </div>
            </div>

            <!-- Today's Appointments -->
            <div class="row">
                <div class="col-md-12">
                    <div class="stats-card">
                        <h5><i class="fas fa-calendar-day text-success me-2"></i>Today's Appointments</h5>
                        <div id="todayAppointmentsList" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading today's appointments...</span>
                                </div>
                                <p class="mt-2">Loading today's appointments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Management and Pending Appointments -->
            <div class="row">
                <div class="col-md-8">
                    <div class="stats-card">
                        <h5><i class="fas fa-users text-primary me-2"></i>Patient Overview</h5>
                        <div id="patientsList" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading patients...</span>
                                </div>
                                <p class="mt-2">Loading patient data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="stats-card">
                        <h5><i class="fas fa-calendar-alt text-warning me-2"></i>Appointment Requests</h5>
                        <div id="appointmentsList" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading appointments...</span>
                                </div>
                                <p class="mt-2">Loading appointments...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load doctor dashboard data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDoctorDashboardData();
        });

        function loadDoctorDashboardData() {
            loadPatientsData();
            loadAppointmentsData();
            loadTodayAppointmentsData();
        }

        function loadPatientsData() {
            fetch('/doctor_patients')
                .then(response => response.json())
                .then(data => {
                    displayPatients(data);
                    updatePatientStats(data);
                })
                .catch(error => {
                    console.error('Error loading patients:', error);
                    showPatientsError();
                });
        }

        function displayPatients(patients) {
            const container = document.getElementById('patientsList');

            if (!patients || patients.length === 0) {
                container.innerHTML = '<p class="text-muted">No patients found.</p>';
                return;
            }

            const patientsHtml = patients.map(patient => {
                const riskBadge = patient.risk_level === 'Low Risk' ? 'risk-low' :
                                 patient.risk_level === 'Moderate Risk' ? 'risk-moderate' : 'risk-high';

                return `
                    <div class="patient-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-user me-2"></i>${patient.username}</h6>
                                <small class="text-muted">${patient.email}</small><br>
                                <small class="text-muted">Assessments: ${patient.total_assessments || 0}</small>
                            </div>
                            <div class="text-end">
                                <span class="risk-badge ${riskBadge}">${patient.risk_level || 'No Data'}</span><br>
                                <small class="text-muted">${patient.last_assessment}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = patientsHtml;
        }

        function updatePatientStats(patients) {
            // Update total patients
            document.getElementById('totalPatients').textContent = patients.length;

            // Update high risk patients
            const highRiskPatients = patients.filter(p => p.risk_level === 'High Risk').length;
            document.getElementById('highRiskPatients').textContent = highRiskPatients;

            // Update assessments today (patients with recent assessments)
            const today = new Date().toDateString();
            const assessmentsToday = patients.filter(p => {
                if (!p.last_assessment || p.last_assessment === 'No assessments') return false;
                const assessmentDate = new Date(p.last_assessment).toDateString();
                return assessmentDate === today;
            }).length;
            document.getElementById('assessmentsToday').textContent = assessmentsToday;
        }

        function loadAppointmentsData() {
            fetch('/doctor_appointments')
                .then(response => response.json())
                .then(data => {
                    displayAppointments(data);
                    document.getElementById('pendingAppointments').textContent = data.length;
                })
                .catch(error => {
                    console.error('Error loading appointments:', error);
                    showAppointmentsError();
                });
        }

        function displayAppointments(appointments) {
            const container = document.getElementById('appointmentsList');

            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<p class="text-muted">No pending appointments.</p>';
                return;
            }

            const appointmentsHtml = appointments.map(appointment => {
                return `
                    <div class="appointment-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-user me-2"></i>${appointment.patient_name}</h6>
                                <small class="text-muted">${appointment.appointment_type}</small><br>
                                <small class="text-muted">${formatDate(appointment.preferred_date)}</small>
                            </div>
                            <div class="text-end">
                                <div class="mb-2">
                                    <button class="btn btn-sm btn-approve me-1" onclick="updateAppointment(${appointment.id}, 'approved')">
                                        <i class="fas fa-check me-1"></i>Approve
                                    </button>
                                    <button class="btn btn-sm btn-reject" onclick="updateAppointment(${appointment.id}, 'rejected')">
                                        <i class="fas fa-times me-1"></i>Reject
                                    </button>
                                </div>
                                <small class="text-muted">${appointment.notes || 'No notes'}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = appointmentsHtml;
        }

        function updateAppointment(appointmentId, status) {
            fetch('/update_appointment_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    appointment_id: appointmentId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ ${data.message}`);
                    // Refresh appointments list
                    loadAppointmentsData();
                } else {
                    alert(`❌ Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error updating appointment:', error);
                alert('❌ Error updating appointment. Please try again.');
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function showTodayAppointmentsError() {
            document.getElementById('todayAppointmentsList').innerHTML = '<p class="text-danger">Error loading today appointments data.</p>';
        }

        function loadTodayAppointmentsData() {
            fetch('/doctor_today_appointments')
                .then(response => response.json())
                .then(data => {
                    displayTodayAppointments(data);
                })
                .catch(error => {
                    console.error('Error loading today appointments:', error);
                    showTodayAppointmentsError();
                });
        }

        function displayTodayAppointments(appointments) {
            const container = document.getElementById('todayAppointmentsList');

            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<p class="text-muted">No appointments scheduled for today.</p>';
                return;
            }

            const appointmentsHtml = appointments.map(appointment => {
                const statusBadge = appointment.status === 'approved' ? 'success' : 'warning';
                const statusIcon = appointment.status === 'approved' ? 'check-circle' : 'clock';

                return `
                    <div class="appointment-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-user me-2"></i>${appointment.patient_name}</h6>
                                <small class="text-muted">${appointment.appointment_type}</small><br>
                                <small class="text-muted">${formatDate(appointment.preferred_date)}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${statusBadge}">
                                    <i class="fas fa-${statusIcon} me-1"></i>${appointment.status}
                                </span><br>
                                <small class="text-muted">${appointment.notes || 'No notes'}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = appointmentsHtml;
        }
    </script>
</body>
</html>
